{% extends "base.html" %}

{% block title %}Interactive Model - CPP DiTTA{% endblock %}



{% block content %}
<h1 class="text-center my-4">CPP-DiTTA Interactive Model </h1>
<h1 class="text-center my-4">Step 1 - Predicting Damage Location</h1>
<div class="text-center">
    <p class="lead">First, seven sensors are used to read stress values along the length of the 24-inch beam.
        The values of these sensors will give insight into the location of any damage along the beam, if any.
    </p>
    <p class="lead">Input stress values for each node on the beam. These may range from 0 to 10,000 psi):</p>
</div>

    <!-- Image of the Beam -->
<!--  <img src='static/beam_2d.jpg' alt="Beam Image" style="width: 100%; display: block; margin: 0px auto;"> -->

    <!-- Case Selection Buttons -->
<div class="text-center my-4">
    <h4>Select a Stress Scenario:</h4>
    <div class="btn-group" role="group" aria-label="Case Presets">
        <button class="btn btn-outline-primary mx-2" type="button" onclick="setCase([8200, 4541, 3347, 1797, 1322, 877, 475])">Case 1</button>
        <button class="btn btn-outline-primary mx-2" type="button" onclick="setCase([7186, 7316, 3316, 1794, 1320, 876, 475])">Case 2</button>
        <button class="btn btn-outline-primary mx-2" type="button" onclick="setCase([4846, 4848, 3778, 1782, 1315, 874, 474])">Case 3</button>
        <button class="btn btn-outline-primary mx-2" type="button" onclick="setCase([4826, 4402, 4084, 1746, 1296, 865, 469])">Case 4</button>
        <button class="btn btn-outline-primary mx-2" type="button" onclick="setCase([4822, 4394, 3360, 4294, 1470, 828, 441])">Case 5</button>
        <button class="btn btn-outline-primary mx-2" type="button" onclick="setCase([4819, 4390, 3350, 1819, 1428, 1844, 527])">Case 6</button>
        <button class="btn btn-outline-primary mx-2" type="button" onclick="setCase([4818, 4389, 3348, 1804, 1347, 998, 1028])">Case 7</button>
    </div>
</div>

<form action="/run_ml" method="POST">
    <div class="text-center my-4">
    <h4>Adjust Stress Values to See the Result:</h4>

        <div class="input-container">
        <div class="input-wrapper">
            <label for="input1" class="input-label">4in Probe</label>
            <div class="input-group">
                <button class="btn btn-secondary btn-sm" type="button" onclick="adjustInput('input1', 100)">&#x25B2;</button>
                <button class="btn btn-secondary btn-sm" type="button" onclick="adjustInput('input1', 1000)">&#x25B2;</button>
                <input type="number" id="input1" name="input1" class="form-control text-center" value="0" min="0" max="20000" step="any">
                <button class="btn btn-secondary btn-sm" type="button" onclick="adjustInput('input1', -1000)">&#x25BC;</button>
                <button class="btn btn-secondary btn-sm" type="button" onclick="adjustInput('input1', -100)">&#x25BC;</button>
            </div>
        </div>

        <div class="input-wrapper">
            <label for="input2" class="input-label">6in Probe</label>
            <div class="input-group">
                <button class="btn btn-secondary btn-sm" type="button" onclick="adjustInput('input2', 100)">&#x25B2;</button>
                <button class="btn btn-secondary btn-sm" type="button" onclick="adjustInput('input2', 1000)">&#x25B2;</button>
                <input type="number" id="input2" name="input2" class="form-control text-center" value="0" min="0" max="20000" step="any" required>
                <button class="btn btn-secondary btn-sm" type="button" onclick="adjustInput('input2', -1000)">&#x25BC;</button>
                <button class="btn btn-secondary btn-sm" type="button" onclick="adjustInput('input2', -100)">&#x25BC;</button>
            </div>
        </div>

        <div class="input-wrapper">
            <label for="input3" class="input-label">10in Probe</label>
            <div class="input-group">
                <button class="btn btn-secondary btn-sm" type="button" onclick="adjustInput('input3', 100)">&#x25B2;</button>
                <button class="btn btn-secondary btn-sm" type="button" onclick="adjustInput('input3', 1000)">&#x25B2;</button>
                <input type="number" id="input3" name="input3" class="form-control text-center" value="0" min="0" max="20000" step="any" required>
                <button class="btn btn-secondary btn-sm" type="button" onclick="adjustInput('input3', -1000)">&#x25BC;</button>
                <button class="btn btn-secondary btn-sm" type="button" onclick="adjustInput('input3', -100)">&#x25BC;</button>
            </div>
        </div>

        <div class="input-wrapper">
            <label for="input4" class="input-label">16in Probe</label>
            <div class="input-group">
                <button class="btn btn-secondary btn-sm" type="button" onclick="adjustInput('input4', 100)">&#x25B2;</button>
                <button class="btn btn-secondary btn-sm" type="button" onclick="adjustInput('input4', 1000)">&#x25B2;</button>
                <input type="number" id="input4" name="input4" class="form-control text-center" value="0" min="0" max="20000" step="any" required>
                <button class="btn btn-secondary btn-sm" type="button" onclick="adjustInput('input4', -1000)">&#x25BC;</button>
                <button class="btn btn-secondary btn-sm" type="button" onclick="adjustInput('input4', -100)">&#x25BC;</button>
            </div>
        </div>

        <div class="input-wrapper">
            <label for="input5" class="input-label">18in Probe</label>
            <div class="input-group">
                <button class="btn btn-secondary btn-sm" type="button" onclick="adjustInput('input5', 100)">&#x25B2;</button>
                <button class="btn btn-secondary btn-sm" type="button" onclick="adjustInput('input5', 1000)">&#x25B2;</button>
                <input type="number" id="input5" name="input5" class="form-control text-center" value="0" min="0" max="20000" step="any" required>
                <button class="btn btn-secondary btn-sm" type="button" onclick="adjustInput('input5', -1000)">&#x25BC;</button>
                <button class="btn btn-secondary btn-sm" type="button" onclick="adjustInput('input5', -100)">&#x25BC;</button>
            </div>
        </div>

        <div class="input-wrapper">
            <label for="input6" class="input-label">20in Probe</label>
            <div class="input-group">
                <button class="btn btn-secondary btn-sm" type="button" onclick="adjustInput('input6', 100)">&#x25B2;</button>
                <button class="btn btn-secondary btn-sm" type="button" onclick="adjustInput('input6', 1000)">&#x25B2;</button>
                <input type="number" id="input6" name="input6" class="form-control text-center" value="0" min="0" max="20000" step="any" required>
                <button class="btn btn-secondary btn-sm" type="button" onclick="adjustInput('input6', -1000)">&#x25BC;</button>
                <button class="btn btn-secondary btn-sm" type="button" onclick="adjustInput('input6', -100)">&#x25BC;</button>
            </div>
        </div>

        <div class="input-wrapper">
            <label for="input7" class="input-label">22in Probe</label>
            <div class="input-group">
                <button class="btn btn-secondary btn-sm" type="button" onclick="adjustInput('input7', 100)">&#x25B2;</button>
                <button class="btn btn-secondary btn-sm" type="button" onclick="adjustInput('input7', 1000)">&#x25B2;</button>
                <input type="number" id="input7" name="input7" class="form-control text-center" value="0" min="0" max="20000" step="any" required>
                <button class="btn btn-secondary btn-sm" type="button" onclick="adjustInput('input7', -1000)">&#x25BC;</button>
                <button class="btn btn-secondary btn-sm" type="button" onclick="adjustInput('input7', -100)">&#x25BC;</button>
            </div>
        </div>
    </div>
</div>

    <!-- Submit button under the beam -->
    <button type="submit" class="btn btn-success btn-lg my-4">Run Machine Learning Model</button>

</form>


<!-- Result content (prediction label, hidden data, etc) -->
<div id="ml-result-container" class="text-center my-4"></div>

    <!-- Unity Canvas for NN1 -->
<div class="text-center my-5">
  <canvas id="unityContainer" width="960" height="400" style="background: #000; display: block; margin: 0 auto;"></canvas>
</div>
<div class="text-center">
    <h1 class="text-center my-4">Step 2 - Predicting Stress Field</h1>
    <p class="lead">The predicted cut location can be passed to a second model, which will generate a stress field across over 30,000 points, showing stress on the beam after the damage
    </p>
</div>
    <!-- New button: run NN2 stress prediction -->
<div class="text-center my-3">
    <button class="btn btn-success btn-lg my-4" onclick="runNN2()">Generate Stress Field</button>
</div>

<!-- Unity Canvas for NN2 Stress Field Display -->
<div class="text-center my-5">
  <canvas id="unityContainer2" width="960" height="400" style="background: #000; display: block; margin: 0 auto;"></canvas>
</div>

    <!-- Centered image below NN2 canvas -->
<div class="text-center my-4">
    <img src="{{ url_for('static', filename='psi_gradient.png') }}" alt="NN2 Output Visualization" style="max-width: 50%; height: auto;">
</div>


<!-- Unity Loader Script (only loaded once) -->
<script src="{{ url_for('static', filename='UnityBuild_NN1/WebGL_NN1_Build4.loader.js') }}"></script>

<!-- Load Unity Instance NN1 -->
<script>
    let unityInstance = null;

    createUnityInstance(document.querySelector("#unityContainer"), {
        dataUrl: "{{ url_for('static', filename='UnityBuild_NN1/WebGL_NN1_Build4.data') }}",
        frameworkUrl: "{{ url_for('static', filename='UnityBuild_NN1/WebGL_NN1_Build4.framework.js') }}",
        codeUrl: "{{ url_for('static', filename='UnityBuild_NN1/WebGL_NN1_Build4.wasm') }}",
        companyName: "YourCompany",
        productName: "YourProduct",
        productVersion: "1.0"
    }).then((instance) => {
        console.log("Unity loaded successfully");
        unityInstance = instance;
    }).catch((message) => {
        console.error("Unity failed to load:", message);
    });
</script>

    <!-- Load Unity Instance NN2 -->
    <script src="{{ url_for('static', filename='UnityBuild_NN2/WebGL_NN2_Build2.loader.js') }}"></script>
<script>
    let unityInstance2 = null;

    createUnityInstance(document.querySelector("#unityContainer2"), {
        dataUrl: "{{ url_for('static', filename='UnityBuild_NN2/WebGL_NN2_Build2.data') }}",
        frameworkUrl: "{{ url_for('static', filename='UnityBuild_NN2/WebGL_NN2_Build2.framework.js') }}",
        codeUrl: "{{ url_for('static', filename='UnityBuild_NN2/WebGL_NN2_Build2.wasm') }}",
        companyName: "YourCompany",
        productName: "NN2 Viewer",
        productVersion: "1.0"
    }).then((instance) => {
        console.log("Unity NN2 loaded successfully");
        unityInstance2 = instance;
    }).catch((message) => {
        console.error("Unity NN2 failed to load:", message);
    });
</script>



<script>
document.querySelector("form").addEventListener("submit", function (e) {
    e.preventDefault(); // prevent full page reload

    const formData = new FormData(this);

    fetch("/run_ml_ajax", {
    method: "POST",
    body: formData
    })
    .then((res) => res.text())
    .then((html) => {
    const container = document.getElementById("ml-result-container");
    container.innerHTML = html;

    //  Extract prediction value from hidden element or response
    const match = html.match(/data-prediction="([\d.]+)"/);
    if (match && unityInstance) {
        const predictedValue = match[1];
        console.log("Sending predicted value to Unity:", predictedValue);
        unityInstance.SendMessage('CutPositionManager', 'ReceivePrediction', predictedValue);
    }
    })
    .catch((err) => {
        alert("An error occurred.");
        console.error(err);
    });
    });
</script>


<script>
    // Adjust the input value with up/down buttons
    function adjustInput(inputId, increment) {
        const input = document.getElementById(inputId);
        const currentValue = parseFloat(input.value);
        let newValue = currentValue + increment;

        // Ensure the new value stays within 0 to 2.5
        if (newValue < 0) newValue = 0;
        if (newValue > 20000) newValue = 20000;

        input.value = newValue;
    }
</script>

<script>
    // sets the sensors with the preset case values
    function setCase(values) {
        values.forEach((val, i) => {
            const input = document.getElementById(`input${i + 1}`);
            if (input) {
                input.value = val;
            }
        });
    }
</script>

<script>
function runNN2() {
    const cutValue = document.getElementById("predicted-cut").getAttribute("data-prediction");

    fetch("/get_stress_field", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ cut_location: cutValue })
    })
    .then(res => res.json())
    .then(data => {
        console.log("Stress data received:", data.length, "nodes");

        // Preview table (same as before)
    //    let previewHTML = "<h4>Sample of Stress Values (first 10 nodes)</h4>";
    //    previewHTML += "<table class='table table-striped'><thead><tr><th>X</th><th>Y</th><th>Z</th><th>Stress</th></tr></thead><tbody>";

    //    for (let i = 0; i < Math.min(10, data.length); i++) {
    //        const point = data[i];
    //        previewHTML += `<tr><td>${point.x.toFixed(4)}</td><td>${point.y.toFixed(4)}</td><td>${point.z.toFixed(4)}</td><td>${point.stress.toFixed(2)} psi</td></tr>`;
    //    }

    //    previewHTML += "</tbody></table>";
    //    document.getElementById("nn2-stress-output").innerHTML = previewHTML;

        // --- Send to Unity WebGL NN2 instance ---
        if (unityInstance2) {
            const jsonData = JSON.stringify(data);
            console.log("Sending stress data to Unity instance #2");
            unityInstance2.SendMessage("WebDataReceiver", "ReceiveStressData", jsonData);
        }

    })
    .catch(err => {
        console.error("Error fetching NN2 stress data:", err);
        alert("Failed to compute stress field.");
    });
}

</script>



<style>
    /* Increase the width of the parent container to accommodate all inputs */
    .input-container {
        max-width: 1000px; /* Increase width to fit all inputs */
        margin: 0 auto; /* Center container on the page */
        display: flex; /* Use flexbox for better control */
        justify-content: space-between; /* Spread inputs evenly */
        flex-wrap: nowrap; /* Prevent wrapping */
    }

    .input-wrapper {
        text-align: center; /* Center labels and buttons */
        flex: 1; /* Allow inputs to resize proportionally */
    }

    .input-group {
        display: flex;
        flex-direction: column; /* Arrange elements vertically */
        align-items: center; /* Center-align the up arrow, text box, and down arrow */
        gap: 5px; /* Add space between elements */
    }

    .btn-secondary {
        padding: 5px;
        font-size: 0.8em;
        width: 30px;
        height: 30px;
        text-align: center;
    }

    input[type="number"].form-control {
    width: 80px;
    text-align: center;
    }

    input[type="number"].form-control::-webkit-outer-spin-button,
    input[type="number"].form-control::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }

</style>

{% endblock %}
